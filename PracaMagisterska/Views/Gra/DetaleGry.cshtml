@model EdytujGreViewModel

<script type="text/javascript">
    $(document).ready(function () {
        pokazUkryjPrzyciskUsuwaniaGracza();
        pokazUkryjPrzyciskOcenianiaGracza();
        zapamietajWartosciGraczy();
        wylaczWalidacjeDanychPrzeciwnikaWTreningu();

        $('body').delegate('.wierszUczestnika input, .wierszUczestnika select', 'change', function () {
            zapamietajWartosciGraczy();
        });

        $('#TypGry').change(function () {
            if ($('#TypGry').val() != '@(TypGry.Trening)' && $('.btn-usunGracza').length > 3) {
                while ($('.btn-usunGracza').length > 3) {
                    $('.btn-usunGracza')[3].click();
                }
            }
            wylaczWalidacjeDanychPrzeciwnikaWTreningu();
        });

    });


    function wylaczWalidacjeDanychPrzeciwnikaWTreningu() {
        if ($('#TypGry').val() == '@(TypGry.Trening)') {
            $("[id$='_ImiePrzeciwnika']").removeAttr("data-val-required");   // tu biore selektorem elementy na stronie w ktorych atrybut id konczy sie na dany ciag znakow , nastepnie usuwam atrybut
            $("[id$='_NazwiskoPrzeciwnika']").removeAttr("data-val-required");
            ponowniePodepnijWalidacje();
        }
        //else {
        //    $("[id$='_ImiePrzeciwnika']").attr("data-val-required", "Pole wymagane");   // tu biore selektorem elementy na stronie w ktorych atrybut id konczy sie na dany ciag znakow , nastepnie usuwam atrybut
        //    $("[id$='_NazwiskoPrzeciwnika']").attr("data-val-required", "Pole wymagane");
        //    ponowniePodepnijWalidacje();
        //}
    }

    function zapamietajWartosciGraczy() {
        $('.wierszUczestnika input, .wierszUczestnika select').each(function () {
            $(this).attr('data-wartosc', $(this).val());
        });
    }
    function przywrocWartosciGraczy() {
        $('.wierszUczestnika input, .wierszUczestnika select').each(function () {
            $(this).val($(this).attr('data-wartosc'));
        });
    }

    function dodajGracza(przycisk) {
        if ($('#TypGry').val() == '@(TypGry.Trening)' || $('.btn-usunGracza').length<3) {
            let wiersz = $(przycisk).closest('.row');
            let skopiowanyWiersz = wiersz.clone();
            skopiowanyWiersz.find('input,select').attr('data-wartosc', '');
            skopiowanyWiersz.find('.has-error').removeClass('has-error');
            skopiowanyWiersz.find('.field-validation-error').removeClass('field-validation-error').addClass('field-validation-valid').empty();
            skopiowanyWiersz.insertAfter(wiersz);
            przeliczIndeksyWUczestnikach();
            ponowniePodepnijWalidacje();
            pokazUkryjPrzyciskUsuwaniaGracza();
            przywrocWartosciGraczy();
            pokazUkryjPrzyciskDodawaniaGracza();
            pokazUkryjPrzyciskOcenianiaGracza();

        }
    }

    function pokazUkryjPrzyciskUsuwaniaGracza() {
        if ($('.btn-usunGracza').length == 1) {
            $('.btn-usunGracza').attr('disabled', true);
        } else {
            $('.btn-usunGracza').removeAttr('disabled');
        }
    }

    function pokazUkryjPrzyciskDodawaniaGracza() {
        if ($('#TypGry').val() != '@(TypGry.Trening)' && $('.btn-usunGracza').length == 3) {
            $('.btn-dodajGracza').attr('disabled', true);
        } else {
            $('.btn-dodajGracza').removeAttr('disabled');
        }
    }
    function pokazUkryjPrzyciskOcenianiaGracza() {
        $(".wierszUczestnika").each(function () {
            let wartoscId = $(this).find(".uczestnikGryId").val();
            if (wartoscId == "") {
                $(this).find(".btn-ocenGracza").attr("disabled", true);
            } else {
                $(this).find(".btn-ocenGracza").removeAttr("disabled");
            }
        })
    }
    function usunGracza(przycisk) {
        let wiersz = $(przycisk).closest('.row');
        wiersz.remove();
        przeliczIndeksyWUczestnikach();
        ponowniePodepnijWalidacje();
        pokazUkryjPrzyciskUsuwaniaGracza();
        przywrocWartosciGraczy();
        pokazUkryjPrzyciskDodawaniaGracza();
    }
    function ponowniePodepnijWalidacje() {
        let form = $("#formularzDetaliGry");
        form.unbind();
        form.data("validator", null);
        $.validator.unobtrusive.parse(document);
    }
    function przeliczIndeksyWUczestnikach() {
        $('.wierszUczestnika').each(function (index) {
            let kopiaWiersza = $(this).clone();
            let obecnyNr = kopiaWiersza.find('input:hidden').attr('name').replace('ListaUczestnikow[', '').replace('].Id', '');
            let nowyHtml = kopiaWiersza[0].outerHTML.replaceAll('ListaUczestnikow[' + obecnyNr, 'ListaUczestnikow[' + index).replaceAll('ListaUczestnikow_' + obecnyNr, 'ListaUczestnikow_' + index);
            $(this).replaceWith(nowyHtml);
        });
    }
    function wybierzPopapZawodnika(kliknietyPrzycisk) {
        if ($("#TypGry").val() != '@(TypGry.Trening)') {
            pokazPopapZawodnika(kliknietyPrzycisk);
        } else {
            pokazPopapZawodnikaTrening(kliknietyPrzycisk);
        }
    }
</script>

<h2>Detale gry</h2>

@using (Html.BeginForm("ZapiszDetaleGry", "Gra", FormMethod.Post, new { id = "formularzDetaliGry" }))
{
    @Html.HiddenFor(x => x.Id)
    @Html.HiddenFor(x => x.IloscZadanWTreningu)
    @Html.HiddenFor(x => x.IloscRund)
    <div class="row">
        <div class="col-sm-12 col-md-5">
            <div class="form-group">
                @Html.LabelFor(x => x.Miejsce)
                <div class="input-group">
                    <div class="input-group-addon"><span class="glyphicon glyphicon-home"></span></div>
                    @Html.TextBoxFor(x => x.Miejsce, new { @class = "form-control", placeholder = Html.DisplayNameFor(x => x.Miejsce) })
                </div>
                @Html.ValidationMessageFor(x => x.Miejsce)
            </div>
        </div>
        <div class="col-sm-4 col-md-3">
            <div class="form-group ">
                @Html.LabelFor(x => x.Data)
                <div class='input-group date-time'>
                    @Html.TextBoxFor(x => x.Data, "{0:yyyy-MM-dd}", new { @class = "form-control", placeholder = Html.DisplayNameFor(x => x.Data) })
                    <span class="input-group-addon">
                        <span class="glyphicon glyphicon-calendar"></span>
                    </span>
                </div>
                @Html.ValidationMessageFor(x => x.Data)
            </div>
        </div>
        <div class="col-sm-8 col-md-4">
            <div class=" form-group">
                @Html.LabelFor(x => x.TypGry)
                <div class=" input-group">
                    <div class="input-group-addon"><span class="glyphicon glyphicon-list" aria-hidden="true"></span></div>
                    @if (Model.Id.HasValue)
                    {
                        @Html.DropDownListFor(x => x.TypGry, Model.ListaTypowGry, new { @class = "form-control", disabled = "disabled" })
                    }
                    else
                    {
                        @Html.DropDownListFor(x => x.TypGry, Model.ListaTypowGry, new { @class = "form-control" })
                    }
                </div>
                @Html.ValidationMessageFor(x => x.TypGry)
            </div>
        </div>
    </div>
    <div class="row">
        <div class="col-sm-3">
            <div class=" form-group">
                @Html.LabelFor(x => x.KategoriaWiekowa)
                <div class=" input-group">
                    <div class="input-group-addon"><span class="glyphicon glyphicon-list" aria-hidden="true"></span></div>
                    @if (Model.Id.HasValue)
                    {
                        @Html.DropDownListFor(x => x.KategoriaWiekowa, Model.ListaKategoriiWiekowych, new { @class = "form-control", disabled = "disabled" })
                    }
                    else
                    {
                        @Html.DropDownListFor(x => x.KategoriaWiekowa, Model.ListaKategoriiWiekowych, new { @class = "form-control" })
                    }
                </div>
                @Html.ValidationMessageFor(x => x.KategoriaWiekowa)
            </div>
        </div>
    </div>

    if (Model.Id == null)
    {
        <h3 class="text-center">Możliwość dodawania graczy będzie dostępna po zapisaniu gry.</h3>

    }
    <br />
    if (Model.Id != null)
    {
        for (int i = 0; i < Model.ListaUczestnikow.Count; i++)
        {
            <div class="row wierszUczestnika">
                @Html.HiddenFor(x => x.ListaUczestnikow[i].Id, new { @class = "uczestnikGryId" })
                <div class="col-sm-3 col-md-3">
                    <div class=" form-group">
                        @Html.LabelFor(x => x.ListaUczestnikow[i].GraczId)
                        <div class=" input-group">
                            <div class="input-group-addon"><span class="glyphicon glyphicon-list" aria-hidden="true"></span></div>
                            @Html.DropDownListFor(x => x.ListaUczestnikow[i].GraczId, new SelectList(Model.ListaGraczy, "Value", "Text", Model.ListaUczestnikow[i].GraczId),
                           "Wybierz gracza", new { @class = "form-control" })
                        </div>
                        @Html.ValidationMessageFor(x => x.ListaUczestnikow[i].GraczId)
                    </div>
                </div>
                <div class="col-sm-3 col-md-3">
                    <div class="form-group">
                        @Html.LabelFor(x => x.ListaUczestnikow[i].ImiePrzeciwnika)
                        <div class="input-group">
                            <div class="input-group-addon"><span class="glyphicon glyphicon-user"></span></div>
                            @Html.TextBoxFor(x => x.ListaUczestnikow[i].ImiePrzeciwnika, new { @class = "form-control", placeholder = Html.DisplayNameFor(x => x.ListaUczestnikow[i].ImiePrzeciwnika) })
                        </div>
                        @Html.ValidationMessageFor(x => x.ListaUczestnikow[i].ImiePrzeciwnika)
                    </div>
                </div>
                <div class="col-sm-4 col-md-4">
                    <div class="form-group">
                        @Html.LabelFor(x => x.ListaUczestnikow[i].NazwiskoPrzeciwnika)
                        <div class="input-group">
                            <div class="input-group-addon"><span class="glyphicon glyphicon-user" style="margin-right:0px;"></span></div>
                            @Html.TextBoxFor(x => x.ListaUczestnikow[i].NazwiskoPrzeciwnika, new { @class = "form-control", placeholder = Html.DisplayNameFor(x => x.ListaUczestnikow[i].NazwiskoPrzeciwnika) })
                        </div>
                        @Html.ValidationMessageFor(x => x.ListaUczestnikow[i].NazwiskoPrzeciwnika)
                    </div>
                </div>

                <div class="col-sm-2 col-md-2">
                    <div class="form-group">
                        <label>&nbsp;</label>
                        <div class="input-group" style="width:100%">
                            <button type="button" class="btn btn-default btn-sm pull-left btn-dodajGracza" title="Dodaj" onclick="dodajGracza(this);">
                                <span class="glyphicon glyphicon-plus"></span>
                            </button>
                            <button type="button" class="btn btn-default btn-sm  btn-usunGracza pull-left" title="Usuń" style="margin-left:10px;" onclick="usunGracza(this);">
                                <span class="glyphicon glyphicon-trash"></span>
                            </button>
                            <button type="button" class="btn btn-default btn-sm pull-left btn-ocenGracza" title="Oceń" style="margin-left:10px;" onclick="wybierzPopapZawodnika(this);"><span class="glyphicon glyphicon-star"></span></button>
                        </div>
                    </div>
                </div>
            </div>
            <br />


        }
    }
    <button class="btn btn-default" id="ZapiszGre">Zapisz</button>
    @Html.ActionLink("Anuluj", "ListaGier", "Gra", null, new { @class = "btn btn-default" })
}

@Html.Partial("_OcenaZawodnikaTrening")
@Html.Partial("_OcenaZawodnika")
